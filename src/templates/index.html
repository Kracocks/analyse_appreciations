<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analyse textes</title>

    <!-- Install JQuery -->
    <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>

    <!-- Install bootstrap -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

    <!-- Install plotly.js -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js"></script>

    <!-- Load dropzone-->
    {{ dropzone.load_css() }}
    {{ dropzone.style('border: 2px dashed #0087F7; border-radius : 20px; min-height: 15%; max-width: 25%') }}
</head>

<body>
    <div>
        <!-- Selection de fichier -->
        <script>
            dropzone_message = ">>> Glissez-déposez ou cliquez pour sélectionner <<< <br><br>"
            temp = "{{ fichier_charge | safe }}" != "" ? "Fichier chargé : {{ fichier_charge | safe }}" : ""
            dropzone_message = dropzone_message + temp
            console.log(dropzone_message)
        </script>

        <!-- affichage de la dropzone-->
        {{ dropzone.create(action='index') }}
        {{ dropzone.load_js() }}
        {{ dropzone.config(
            custom_options='addRemoveLinks: true, 
                            dictDefaultMessage: dropzone_message') }}

        <!-- Selection de fichier récent -->
        <form method="post" enctype="multipart/form-data" id="recent_file_form">
            <label for="recent_files_choice">Choisir un fichier récemment utilisé</label>
            <select name="recent_files_choice" id="recent_files_choice">
                <option value="">Aucun fichier choisi</option>
                {% for fichier_recent in fichiers_recents %}
                <option value="{{ fichier_recent }}">{{ fichier_recent }}</option>
                {% endfor %}
            </select>
        </form>
        <script src="{{url_for('static', filename='on_file_selected.js')}}"></script>

        <!-- Selection de paramètres pour le graphique -->
        <form method="post" id="parametre_form">
            <label for="variables_choice">Choisir des variables</label>
            <select name="variables_choice" id="variables_choice">
            
            </select>
            
            <label for="modeles_choice">Choisir un modele</label>
            <select name="modeles_choice" id="modeles_choice">
                {% for modele in modeles_disponibles %}
                <option value="{{ modele }}" {% if modele==modele_selectionne %}selected{% endif %}>{{ modele }}</option>
                {% endfor %}
            </select>
        </form>
        <script src="{{url_for('static', filename='on_parametre_change.js')}}"></script>

    </div>

    <!-- Affichage du graphique -->
    {% if graph != "" %}
    <div class="chart" id="bargraph"></div>
    <p id="selected_text"></p>
    <script>
        var graphs = {{ graph | safe}};
        Plotly.plot('bargraph', graphs, {});

        var graphique = document.getElementById('bargraph');
        var selected_text = '';

        graphique.on('plotly_click', function(data){
            for(var i=0; i < data.points.length; i++){
                if (data.points[i].fullData.name == "appréciations générales") {
                    selected_text = "Texte sélectionné : " +data.points[i].customdata
                }
            }
            
            var paragraph = document.getElementById("selected_text");
            paragraph.textContent = selected_text
        });

    </script>
    {% endif %}

    <!-- Bar de chargement -->
    <div class="progress" id="progress" style="width: 50%; margin: 50px;">
		<div class="progress-bar progress-bar-striped active" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%">
			<span class="progress-bar-label">0%</span>
		</div>
	</div>

    <script>
        var source = new EventSource("/progress");
        source.onmessage = function(event) {
            var graphique = document.getElementById("bargraph");
            var progress = document.getElementById("progress");

            graphique.style.display = "none";
            progress.style.display = "block";

            var data = JSON.parse(event.data)
            
            console.log(event)
            $('.progress-bar').css('width', data.progression+'%').attr('aria-valuenow', data.progression);
		    $('.progress-bar-label').text(data.progression+'%');
    
            if(data.progression == 100){
                graphique.style.display = "block";
                progress.style.display = "none";
                source.close()
            }
        }
    </script>
    
</body>

</html>